{% extends 'layout.html' %}
{% block title %}Bulk Upload Â· VVStore{% endblock %}

{% block content %}
<section class="page-heading">
    <div>
        <h1>Bulk Upload Catalog</h1>
        <p class="lead">Drop in a CSV to provision multiple SKUs with accurate pricing instantly.</p>
    </div>
    <a class="ghost-button" href="{{ url_for('upload') }}"><i class="fas fa-plus"></i> Single Upload</a>
</section>

<section class="card form-card">
    <div class="card-header align-start">
        <div>
            <h2>Upload Instructions</h2>
            <p class="card-subtitle">Accepted columns: <strong>item_name, category, supplier, purchase_price, profit_margin, quantity</strong></p>
        </div>
        <a class="ghost-button" href="{{ url_for('static', filename='bulk_template.csv') }}" download><i class="fas fa-download"></i> Download Template</a>
    </div>

    <form id="bulkUploadForm" method="POST" enctype="multipart/form-data" class="upload-form">
        <div class="drag-drop" id="dragArea">
            <i class="fas fa-cloud-arrow-up"></i>
            <h3>Upload CSV File</h3>
            <p>Drag &amp; drop or browse from your computer</p>
            <button type="button" class="ghost-button" id="browseButton"><i class="fas fa-folder-open"></i> Browse Files</button>
            <input type="file" name="file" id="fileInput" accept=".csv" hidden>
            <p class="helper-text" id="fileName">No file selected</p>
        </div>
        <div class="form-actions">
            <button type="submit"><i class="fas fa-file-import"></i> Process Upload</button>
            <a class="ghost-button" href="{{ url_for('index') }}"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        </div>
    </form>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const dropArea = document.getElementById('dragArea');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const browseButton = document.getElementById('browseButton');
    const form = document.getElementById('bulkUploadForm');

    const highlight = () => dropArea.classList.add('active');
    const unhighlight = () => dropArea.classList.remove('active');

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, (event) => {
            event.preventDefault();
            highlight();
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (event) => {
            event.preventDefault();
            if (eventName === 'drop') {
                if (event.dataTransfer.files.length) {
                    fileInput.files = event.dataTransfer.files;
                    updateFileName();
                    form.requestSubmit();
                }
            }
            unhighlight();
        });
    });

    dropArea.addEventListener('click', () => fileInput.click());
    browseButton.addEventListener('click', (event) => {
        event.preventDefault();
        fileInput.click();
    });
    fileInput.addEventListener('change', updateFileName);

    function updateFileName() {
        if (fileInput.files.length) {
            fileName.textContent = fileInput.files[0].name;
        } else {
            fileName.textContent = 'No file selected';
        }
    }

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!fileInput.files.length) {
            alert('Please select a CSV file before uploading.');
            return;
        }

        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: formData,
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            const contentType = response.headers.get('Content-Type') || '';
            if (contentType.includes('application/json')) {
                return response.json();
            }
            return response.text();
        }).then(data => {
            if (!data) return;
            if (typeof data === 'object' && data.message) {
                alert(data.message);
            }
            window.location.reload();
        }).catch(error => {
            alert('Error uploading file: ' + error);
        });
    });
</script>
{% endblock %}
